{% extends "libs/base.html" %}
{% load staticfiles %}
{% block style %}
<style>
.register-form {
  margin-top: 10px;
}
</style>
{% endblock %}
{% block container %}
{% include "libs/title.html" with title="注册" %}
<div class="am-container">
    {% if status and status == 'success' %}
    <div class="am-text-center" style="margin-top:3rem">
        <h2>您已注册成功！{% if order_id %}您有未付款订单，是否继续？{% endif %}</h2>

        <a href="{% url 'main' %}" class="am-btn am-btn-sm am-btn-beauty">去逛逛</a>
        {% if order_id %}<a href="{% url 'shopcart_order_checkout' %}?order_id={{order_id}}" class="am-btn am-btn-sm am-btn-beauty">去付款</a>{% endif %}

    </div>
    {% elif status == 'field-failed' %}
    <div class="am-text-center" style="margin-top:3rem;">
        {% if 'phone' in errors %}
            <h3>手机号码不能为空！</h3>
        {% endif %}
        {% if 'password' in errors %}
            <h3>密码不能为空！</h3>
        {% endif %}
        {% if 'verifycode' in errors %}
            <h3>密码不能为空！</h3>
        {% endif %}
        <a href="{% url 'register' %}" class="am-btn am-btn-beauty am-btn-sm am-center">返回</a>
    </div>
    {% elif status == 'verify-failed' %}
    <div class="am-text-center" style="margin-top:3rem;">
        <h3>{{message}}，返回重试！</h3>
        <a href="{% url 'register' %}" class="am-btn am-btn-beauty am-btn-sm am-center">返回</a>
    </div>
    {% elif status == 'db-failed' %}
    <div  class="am-text-center" style="margin-top:3rem;">
        <h3>{{errors.message}}</h3>
        <a href="{% url 'register' %}" class="am-btn am-btn-beauty am-btn-sm am-center">返回</a>
    </div>
    {% else %}
        {% if status == 'invite_customer' %}
            <div class="am-modal am-modal-no-btn" tabindex="-1" id="showmessage">
                <div class="am-modal-dialog">
                    <div class="am-modal-hd"><a href="javascript: void(0)" class="am-close am-close-spin" data-am-modal-close>&times;</a></div>
                    <div class="am-modal-bd">
                    <p id="showmessage_content">长按并选择扫描屏幕二维码<img src="{% static 'img/64.pic_hd.jpg' %}" /></p>
                    <a href="javascript: void(0)" data-am-modal-close class="am-btn am-btn-beauty am-btn-sm">确定</a>
                    </div>
                </div>
            </div>
            
        {% endif %}

        <form class="register-form am-form" data-am-validator method="POST" action="{% url 'register' %}">
            {% csrf_token %}
            <div class="am-form-group">
                <label class="am-form-label">手机</label>
                <input type="text" name="phone" placeholder="请输入您的手机号码" required pattern="^\d{11}$" />
            </div>

            <div class="am-form-group">
                <label class="am-form-label">密码</label>
                <input type="password" name="password" id="password" placeholder="请输入您的帐号密码" required />
            </div>

            <div class="am-form-group">
                <label class="am-form-label">重复密码</label>
                <input type="password" name="repassword" placeholder="请重复输入您的帐号密码" required data-equal-to="#password" />
            </div>

            <div class="am-form-group">
                <label class="am-form-label am-block">短信验证码</label>
                <input type="text" name="verifycode" class="am-form-field" style="width:50%;display:inline;" required>
                <a class="am-btn am-btn-default" type="button" id="verify">获取验证码</a>
            </div>

            <div class="am-form-group">
                <div class="am-center" style="width:18rem;">
                    <button type="submit" class="am-btn am-btn-beauty">注册</button>
                    <a href="{% url "login" %}" class="am-btn am-btn-beauty">返回登陆</a>
                </div>
            </div>
            
        </form>
    {% endif %}
</div>
{% endblock %}
{% block script %}
<script>
$(function(){
    $('#verify').on('click',function(){
        phone = $('input[name="phone"]').val();
        if(phone!=''){
            $.get("{% url 'verify'%}", {'vt':{{verify_token}}, 'phone':phone}, function(ret){
                if(ret['status']=='success'){
                    $('#verify').html('重新获取(<label>60</label>s)');
                    $('#verify').attr('disabled','disabled');
                    setTimeout(timecount, 1000);  
                }else if(ret['status']=='waiting'){
                    $('#verify').html('重新获取(<label>60</label>s)');
                }else{
                    $('input[name="phone"]').trigger("focus");
                }
            });
              
        }
        
    });
    $('#showmessage').modal({
        'closeViaDimmer' : 0,
        'width': 300,
        'height': 120, 
    });
});
function timecount(){
    var num = parseInt($('#verify label').html());
    if(num>1){
        $('#verify label').html(num-1);
        setTimeout(timecount, 1000);
    }else{
        $('#verify label').html(60);
        $('#verify').removeAttr('disabled');
    }
}
</script>
{% endblock %}